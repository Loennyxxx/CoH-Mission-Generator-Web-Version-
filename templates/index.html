<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>NOMOS â€“ Missionsgenerator</title>

<!-- Stylesheet -->
<link rel="stylesheet" href="/static/style.css">

<!-- Favicon -->
<link rel="icon" href="/static/favicon.ico" type="image/x-icon">
<link rel="icon" href="/static/favicon.png" type="image/png">
<link rel="apple-touch-icon" href="/static/favicon.png">

<style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    background-color: #121212;
    color: #e0e0e0;
    font-family: Consolas, monospace;
    overflow-y: auto; /* Seite kann scrollen */
}

body {
    display: flex;
    flex-direction: column;
}

#container {
    display: flex;
    flex-direction: column;
    min-height: 100vh; /* Container fÃ¼llt Viewport */
    width: 100%;
    box-sizing: border-box;
    padding: 0;
}

#log {
    background-color: #121212; /* Textfeld ohne extra Rand */
    padding: 20px;
    flex: 1; /* fÃ¼llt den verfÃ¼gbaren Platz */
    overflow-y: auto; /* nur Log scrollt bei Ãœberlauf */
    white-space: pre-wrap;
    font-size: 20px; /* gut lesbar auf 1080p */
    line-height: 1.4;
    margin: 0;
}

#button-row {
    display: flex;
    justify-content: center;
    gap: 10px; /* Abstand zwischen Buttons */
    margin: 10px 0;
}

#btn {
    background-color: #d32f2f;
    color: white;
    border: none;
    padding: 15px 40px;
    font-size: 22px;
    font-weight: bold;
    border-radius: 10px;
    cursor: pointer;
}

#btn:disabled {
    background-color: #a12a2a;
    cursor: not-allowed;
}

#music-btn {
    background-color: #4caf50; /* grÃ¼n */
    color: white;
    border: none;
    padding: 15px 20px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 10px;
    cursor: pointer;
}
#music-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>
</head>
<body>

<div id="container">
    <div id="log">
        <pre id="output">Nomos >> System bereit. Warte auf Missionsbefehl.</pre>
    </div>

    <div id="button-row">
        <button id="btn">ðŸš€ MISSION GENERIEREN</button>
        <button id="music-btn">ðŸŽµ Musik An</button>
    </div>
</div>

<!-- Hintergrundmusik -->
<audio id="bg-music" autoplay loop>
    <source src="/static/audio/hochzeitsmarsch.mp3" type="audio/mpeg">
    Dein Browser unterstÃ¼tzt kein Audio-Tag.
</audio>

<script>
const output = document.getElementById("output");
const btn = document.getElementById("btn");
const musicBtn = document.getElementById("music-btn");
const music = document.getElementById("bg-music");

music.volume = 0.2; // leise Hintergrundmusik

let polling = false;
let lastScrollHeight = 0;

// Mission starten
btn.onclick = async () => {
    if (btn.disabled) return;

    btn.disabled = true;
    btn.textContent = "â³ GENERIERT...";

    try {
        // Autoplay-Probleme umgehen
        music.play().catch(() => { /* falls Browser blockiert */ });

        await fetch("/start", { method: "POST" });
    } catch (err) {
        output.textContent += "\n[Client] Fehler beim Start der Mission.\n";
        btn.disabled = false;
        btn.textContent = "ðŸš€ MISSION GENERIEREN";
    }
};

// Musik ein-/ausschalten
musicBtn.onclick = () => {
    if (music.paused) {
        music.play();
        musicBtn.textContent = "ðŸŽµ Musik Aus";
    } else {
        music.pause();
        musicBtn.textContent = "ðŸŽµ Musik An";
    }
};

// Polling lÃ¤uft immer, direkt beim Laden der Seite
async function poll() {
    try {
        const res = await fetch("/logs");
        const data = await res.json();

        const shouldScroll = output.scrollTop + output.clientHeight >= lastScrollHeight - 5;
        output.textContent = data.logs;

        if (shouldScroll) {
            output.scrollTop = output.scrollHeight;
        }

        lastScrollHeight = output.scrollHeight;

        // Button wieder aktivieren, wenn Mission fertig
        if (!data.running) {
            btn.disabled = false;
            btn.textContent = "ðŸš€ MISSION GENERIEREN";
        }

        setTimeout(poll, 500);
    } catch (err) {
        output.textContent += "\n[Client] Verbindungsfehler.\n";
        setTimeout(poll, 2000);
    }
}

// Polling direkt beim Laden der Seite starten
window.onload = () => {
    if (!polling) {
        polling = true;
        poll();
    }
};
</script>

</body>
</html>
